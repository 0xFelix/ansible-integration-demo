apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: create-win-vm-and-run-ansible
  namespace: kubevirt
spec:
  params:
    - name: sourceTemplateName
      description: Name of the Template which is used to create the VirtualMachine to run Ansible on.
      type: string
      default: windows10-with-sysprep
    - name: sourceTemplateNamespace
      description: Namespace of the Template which is used to create the VirtualMachine to run Ansible on.
      type: string
      default: kubevirt
    - name: playbookGitRepoURL
      description: URL to the git repository of the playbook that should be run.
      type: string
    - name: playbookGitRevision
      description: Git revision of the playbook that should be run.
      type: string
      default: main
    - name: playbookFilename
      description: Filename of the playbook that should be run.
      type: string
      default: playbook.yml
    - name: sysprepConfigMapName
      description: Name of ConfigMap that contains sysprep unattend.xml for basic setup of the VM and configuring remoting.
      type: string
      default: windows10-unattend-winrm
  workspaces:
    - name: ansible
  tasks:
    - name: create-vm-from-template
      params:
        - name: templateName
          value: $(params.sourceTemplateName)
        - name: templateNamespace
          value: $(params.sourceTemplateNamespace)
        - name: templateParams
          value:
            - "SYSPREP_CONFIGMAP_NAME:$(params.sysprepConfigMapName)"
        - name: runStrategy
          value: RerunOnFailure
        - name: startVM
          value: "true"
      timeout: 10m
      taskRef:
        kind: ClusterTask
        name: create-vm-from-template
    - name: wait-for-vmi-status
      params:
        - name: vmiName
          value: $(tasks.create-vm-from-template.results.name)
        - name: successCondition
          value: status.guestOSInfo.id notin ()
        - name: failureCondition
          value: status.phase in (Failed, Unknown)
      runAfter:
        - create-vm-from-template
      timeout: 1h
      taskRef:
        kind: ClusterTask
        name: wait-for-vmi-status
    - name: create-inventory
      params:
        - name: SCRIPT
          value: |
            #!/usr/bin/env bash
            set -x

            mkdir $(workspaces.manifest-dir.path)/inventory

            oc get \
              vmi \
              $(tasks.create-vm-from-template.results.name) \
              -n $(tasks.create-vm-from-template.results.namespace) \
              -o go-template='vm ansible_user=Administrator ansible_password=password ansible_connection=winrm ansible_winrm_transport=credssp ansible_winrm_server_cert_validation=ignore ansible_host={{ index (index .status.interfaces 0) "ipAddress" }}' \
              > $(workspaces.manifest-dir.path)/inventory/hosts
      workspaces:
        - name: manifest-dir
          workspace: ansible
      runAfter:
        - wait-for-vmi-status
      timeout: 10m
      taskRef:
        kind: ClusterTask
        name: openshift-client
    - name: git-clone
      params:
        - name: url
          value: $(params.playbookGitRepoURL)
        - name: revision
          value: $(params.playbookGitRevision)
        - name: deleteExisting
          value: "false"
      workspaces:
        - name: output
          workspace: ansible
      runAfter:
        - create-inventory
      timeout: 10m
      taskRef:
        kind: ClusterTask
        name: git-clone
    - name: ansible-runner
      params:
        - name: project-dir
          value: .
        - name: args
          value:
            - -p
            - $(params.playbookFilename)
      workspaces:
        - name: runner-dir
          workspace: ansible
      runAfter:
        - git-clone
      timeout: 1h
      taskRef:
        kind: Task
        name: ansible-runner
  results:
    - name: vmName
      description: Name of the created VirtualMachine
      value: $(tasks.create-vm-from-template.results.name)
    - name: vmNamespace
      description: Namespace of the created VirtualMachine
      value: $(tasks.create-vm-from-template.results.namespace)
    - name: publicKeySecretName
      description: Name of the created public key Secret
      value: $(tasks.generate-ssh-keys.results.publicKeySecretName)
    - name: publicKeySecretNamespace
      description: Namespace of the created public key Secret
      value: $(tasks.generate-ssh-keys.results.publicKeySecretNamespace)
    - name: privateKeySecretName
      description: Name of the created private key Secret
      value: $(tasks.generate-ssh-keys.results.privateKeySecretName)
    - name: privateKeySecretNamespace
      description: Namespace of the created private key Secret
      value: $(tasks.generate-ssh-keys.results.privateKeySecretNamespace)
